/**
 * @fileoverview Firestore Security Rules for CannaConnect.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for most data, with specific
 * exceptions for public reads on certain collections and shared access for
 * direct messages. It prioritizes security and data isolation, ensuring users
 * can only access their own data unless explicitly permitted otherwise.
 *
 * Data Structure:
 * - /users/{userId}: User profile information, where {userId} is the Firebase Auth UID.
 * - /users/{userId}/posts/{postId}: Posts created by a specific user.
 * - /users/{userId}/posts/{postId}/comments/{commentId}: Comments on a specific post.
 * - /users/{userId}/cultivationTasks/{taskId}: Cultivation tasks created by a specific user.
 * - /users/{userId}/plantAnalyses/{analysisId}: Plant analysis records created by a specific user.
 * - /messages/{messageId}: Direct messages between users.
 *
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - All user-owned data is strictly controlled by the corresponding Firebase Auth UID.
 * - Direct messages are accessible only to the sender and recipient.
 *
 * Denormalization for Authorization:
 * - The `authorId` field is present in Post, Comment, CultivationTask, and PlantAnalysis documents
 *   to enable fast ownership checks without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces that only the authenticated user can read or write their own profile data.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creates their own profile with matching UID.
     * @allow (get, list, update, delete) - Authenticated user reads/modifies their own profile.
     * @deny (create) - User attempts to create a profile with a different UID.
     * @deny (get, list, update, delete) - User attempts to read/modify another user's profile.
     * @principle Enforces document ownership and protects user privacy.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the owner can manage their posts.
     * @path /users/{userId}/posts/{postId}
     * @allow (create) - Authenticated user creates a post under their own user ID, and the authorId matches the user ID.
     * @allow (get, list, update, delete) - Authenticated user reads/modifies their own posts.
     * @deny (create) - User attempts to create a post under another user's ID or the authorId does not match the user ID.
     * @deny (get, list, update, delete) - User attempts to read/modify another user's posts.
     * @principle Enforces document ownership for user-generated content.
     */
    match /users/{userId}/posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.authorId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the post owner can manage comments on their posts.
     * @path /users/{userId}/posts/{postId}/comments/{commentId}
     * @allow (create) - Authenticated user creates a comment under a post they own.
     * @allow (get, list, update, delete) - Authenticated user reads/modifies comments on their own posts.
     * @deny (create) - User attempts to create a comment under a post not owned by them.
     * @deny (get, list, update, delete) - User attempts to read/modify comments on posts not owned by them.
     * @principle Enforces document ownership for comments within user-owned posts.
     */
    match /users/{userId}/posts/{postId}/comments/{commentId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.authorId == request.auth.uid;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the task owner can manage their cultivation tasks.
     * @path /users/{userId}/cultivationTasks/{taskId}
     * @allow (create) - Authenticated user creates a cultivation task under their own user ID.
     * @allow (get, list, update, delete) - Authenticated user reads/modifies their own tasks.
     * @deny (create) - User attempts to create a task under another user's ID.
     * @deny (get, list, update, delete) - User attempts to read/modify another user's tasks.
     * @principle Enforces document ownership for cultivation tasks.
     */
    match /users/{userId}/cultivationTasks/{taskId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.authorId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the analysis owner can manage their plant analysis records.
     * @path /users/{userId}/plantAnalyses/{analysisId}
     * @allow (create) - Authenticated user creates a plant analysis record under their own user ID.
     * @allow (get, list, update, delete) - Authenticated user reads/modifies their own analysis records.
     * @deny (create) - User attempts to create an analysis record under another user's ID.
     * @deny (get, list, update, delete) - User attempts to read/modify another user's analysis records.
     * @principle Enforces document ownership for plant analysis records.
     */
    match /users/{userId}/plantAnalyses/{analysisId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
       function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.authorId == userId;
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Enforces that only the sender and recipient can access a chat message.
     * @path /messages/{messageId}
     * @allow (create) - Authenticated user creates a message where they are the sender.
     * @allow (get, list) - Authenticated user is either the sender or the recipient of the message.
     * @allow (update, delete) - Not allowed, messages are immutable.
     * @deny (create) - User attempts to create a message with a sender ID that does not match their own.
     * @deny (get, list) - User attempts to access a message where they are neither the sender nor the recipient.
     * @deny (update, delete) - All updates and deletes are denied.
     * @principle Enforces shared access for direct messages based on sender and recipient IDs.
     */
    match /messages/{messageId} {
      function isSignedIn() {
        return request.auth != null;
      }
      function isSender(senderId) {
        return request.auth.uid == senderId;
      }
      function isRecipient(recipientId) {
        return request.auth.uid == recipientId;
      }

      allow create: if isSignedIn() && isSender(request.resource.data.senderId);
      allow get: if isSignedIn() && (isSender(resource.data.senderId) || isRecipient(resource.data.recipientId));
      allow list: if isSignedIn() && (isSender(resource.data.senderId) || isRecipient(resource.data.recipientId));
      allow update: if false;
      allow delete: if false;
    }
  }
}