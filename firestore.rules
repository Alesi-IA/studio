/**
 * @fileoverview Firestore Security Rules for CannaConnect application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for most data, with specific exceptions for chat messages, which are secured based on sender and recipient. All user-generated content (posts, comments, cultivation tasks, and plant analyses) is stored under user-specific paths. This design avoids complex `get()` calls in security rules, enabling atomic operations and improved debuggability.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile information. The `userId` corresponds to the Firebase Auth UID.
 * - /users/{userId}/posts/{postId}: Stores posts created by a specific user.
 * - /users/{userId}/posts/{postId}/comments/{commentId}: Stores comments associated with a specific post.
 * - /users/{userId}/cultivationTasks/{taskId}: Stores cultivation tasks created by a specific user.
 * - /users/{userId}/plantAnalyses/{analysisId}: Stores plant analysis records created by a specific user.
 * - /messages/{messageId}: Stores chat messages between users.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied to protect user privacy.
 * - All write operations are protected by authorization checks based on user ownership.
 * - Data validation is limited to fields critical for authorization and relational integrity.
 *
 * Denormalization for Authorization:
 * The data model denormalizes author/owner IDs onto documents to avoid costly `get()` calls in security rules. For example, posts contain an `authorId` field that must match the `userId` in the path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the document.
     * @param {string} userId The user ID to check against the authenticated user's UID.
     * @return {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the document, and that the document already exists.
     * @param {string} userId The user ID to check against the authenticated user's UID.
     * @return {boolean} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Denies listing of all users. This is a privacy measure.
     * @path /users
     * @allow None - Listing users is not permitted.
     * @deny (list) - Any attempt to list users.
     * @principle Enforces user privacy by preventing unauthorized listing of user profiles.
     */
    match /users {
      allow get: if false; // Getting a specific user is fine if you know the ID.
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages access to user profile information.
     * @path /users/{userId}
     * @allow (create) - A user can create their own profile if the `userId` matches their auth UID.
     * @allow (get, update, delete) - A user can read, update, and delete their own profile.
     * @deny (create) - A user cannot create a profile for another user.
     * @deny (get, update, delete) - A user cannot read, update or delete another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to posts created by a user.
     * @path /users/{userId}/posts/{postId}
     * @allow (create) - A user can create a post under their own user ID.
     * @allow (get, list, update, delete) - A user can read, list, update, and delete their own posts.
     * @deny (create) - A user cannot create a post under another user's ID.
     * @deny (get, list, update, delete) - A user cannot read, list, update, or delete another user's posts.
     * @principle Enforces document ownership for posts.
     */
    match /users/{userId}/posts/{postId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to comments on a specific post.
     * @path /users/{userId}/posts/{postId}/comments/{commentId}
     * @allow (create) - A user can create a comment on a post under their own user ID.
     * @allow (get, list, update, delete) - A user can read, list, update, and delete their own comments.
     * @deny (create) - A user cannot create a comment under another user's ID.
     * @deny (get, list, update, delete) - A user cannot read, list, update, or delete another user's comments.
     * @principle Enforces document ownership for comments.
     */
    match /users/{userId}/posts/{postId}/comments/{commentId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to cultivation tasks created by a user.
     * @path /users/{userId}/cultivationTasks/{taskId}
     * @allow (create) - A user can create a cultivation task under their own user ID.
     * @allow (get, list, update, delete) - A user can read, list, update, and delete their own cultivation tasks.
     * @deny (create) - A user cannot create a cultivation task under another user's ID.
     * @deny (get, list, update, delete) - A user cannot read, list, update, or delete another user's cultivation tasks.
     * @principle Enforces document ownership for cultivation tasks.
     */
    match /users/{userId}/cultivationTasks/{taskId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to plant analysis records created by a user.
     * @path /users/{userId}/plantAnalyses/{analysisId}
     * @allow (create) - A user can create a plant analysis record under their own user ID.
     * @allow (get, list, update, delete) - A user can read, list, update, and delete their own plant analysis records.
     * @deny (create) - A user cannot create a plant analysis record under another user's ID.
     * @deny (get, list, update, delete) - A user cannot read, list, update, or delete another user's plant analysis records.
     * @principle Enforces document ownership for plant analysis records.
     */
    match /users/{userId}/plantAnalyses/{analysisId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(userId) && request.resource.data.authorId == resource.data.authorId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages access to chat messages between users. Only the sender and recipient can access the message.
     * @path /messages/{messageId}
     * @allow (create) - A user can create a chat message. The `senderId` and `recipientId` must be valid user IDs.
     * @allow (get) - The sender or recipient can read the message.
     * @deny (list, update, delete) - Listing, updating, and deleting messages is not allowed.
     * @principle Enforces access control based on sender and recipient IDs for chat messages.
     */
    match /messages/{messageId} {
      allow get: if isSignedIn() && (resource.data.senderId == request.auth.uid || resource.data.recipientId == request.auth.uid);
      allow list: if false;
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
  }
}