{
  "rules": {
    "users": {
      "$userId": {
        // PERMISOS DE LECTURA
        // Cualquier usuario autenticado puede leer el perfil de otro usuario.
        "allow read": "if request.auth != null;",
        
        // PERMISOS DE ESCRITURA
        // Un usuario solo puede crear su propio perfil.
        "allow create": "if request.auth.uid == $userId;",
        
        // Un usuario puede actualizar su propio perfil.
        // Los administradores (owner, co-owner) pueden actualizar cualquier perfil.
        "allow update": "if request.auth.uid == $userId || get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role in ['owner', 'co-owner'];",
        
        // Solo los administradores (owner, co-owner) pueden eliminar usuarios.
        "allow delete": "if get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role in ['owner', 'co-owner'];"
      },
      // Permitir a cualquier usuario autenticado listar los perfiles de usuario.
      // Esto es necesario para que el panel de administrador y futuras funciones de búsqueda funcionen.
      "allow list": "if request.auth != null;"
    },
    "roles": {
      "$userId": {
        // PERMISOS DE LECTURA
        // Solo el propio usuario y los administradores pueden leer un rol.
        "allow read": "if request.auth.uid == $userId || get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role in ['owner', 'co-owner'];",
        
        // PERMISOS DE ESCRITURA
        // Un usuario puede crear su propio documento de rol al registrarse.
        "allow create": "if request.auth.uid == $userId;",
        
        // Solo los dueños pueden cambiar roles.
        "allow write": "if get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'owner';"
      }
    },
    "posts": {
      "$postId": {
        // Cualquiera puede leer las publicaciones
        "allow read": "if true;",
        // Un usuario solo puede crear/actualizar/eliminar sus propias publicaciones
        "allow write": "if request.auth.uid == request.resource.data.authorId;"
      }
    },
    "comments": {
      "$commentId": {
        // Cualquiera puede leer los comentarios
        "allow read": "if true;",
        // Un usuario solo puede crear sus propios comentarios
        "allow create": "if request.auth.uid == request.resource.data.authorId;",
        // Un usuario puede eliminar sus propios comentarios, o un moderador puede eliminar cualquiera
        "allow delete": "if request.auth.uid == resource.data.authorId || get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role in ['owner', 'co-owner', 'moderator'];"
      }
    },
    "cultivationTasks": {
      "$taskId": {
        // Un usuario solo puede acceder a sus propias tareas de cultivo
        "allow read, write": "if request.auth.uid == resource.data.authorId;"
      }
    },
    "plantAnalyses": {
      "$analysisId": {
        // Un usuario solo puede acceder a sus propios análisis de plantas
        "allow read, write": "if request.auth.uid == resource.data.authorId;"
      }
    },
    "messages": {
      "$messageId": {
        // Solo el remitente o el destinatario pueden leer/escribir un mensaje
        "allow read, write": "if request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.recipientId;"
      }
    }
  }
}
